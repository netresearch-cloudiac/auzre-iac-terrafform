name: $(Date:yyyyMMdd)$(Rev:.r)
variables:
  var1: value1
  terraform_templates_dir: 03-networks

trigger:
  - push
  
pool:
  vmImage: ubuntu-latest
  
stages:
  - stage: validate
    jobs:
    - job: terraform_init
      steps:
        # - task: TerraformInstaller@0
        #   displayName: install terraform
        #   inputs:
        #     terraformVersion: 'latest'
        - task: TerraformTaskV2@2
          inputs:
            provider: 'azurerm'
            command: 'init'
            workingDirectory: $(terraform_templates_dir)
            backendServiceArm: 'Visual Studio Enterprise – MPN(07209e8b-f025-434a-98ee-5e5430ed50b1)'
            backendAzureRmResourceGroupName: 'RG-common-base'
            backendAzureRmStorageAccountName: 'tfcmmgtstatestore'
            backendAzureRmContainerName: 'tfstatecontainer'
            backendAzureRmKey: 'backendsetup.terraform.tfstate'
    # - job: terraform_validate
    #  steps:
        - task: TerraformTaskV2@2
          inputs:
            provider: 'azurerm'
            #command: 'init'
            command: 'validate'
            workingDirectory: '$(terraform_templates_dir)' 
  - stage: plan
    jobs:
    - job: terraform_init
      steps:
        # - task: TerraformInstaller@0
        #   displayName: install terraform
        #   inputs:
        #     terraformVersion: 'latest'
        - task: TerraformTaskV2@2
          inputs:
            provider: 'azurerm'
            command: 'init'
            workingDirectory: $(terraform_templates_dir)
            backendServiceArm: 'Visual Studio Enterprise – MPN(07209e8b-f025-434a-98ee-5e5430ed50b1)'
            backendAzureRmResourceGroupName: 'RG-common-base'
            backendAzureRmStorageAccountName: 'tfcmmgtstatestore'
            backendAzureRmContainerName: 'tfstatecontainer'
            backendAzureRmKey: 'backendsetup.terraform.tfstate'
    #- job: planning
    #  steps:
        - task: TerraformTaskV2@2
          inputs:
            provider: 'azurerm'
            command: 'plan'
            commandOptions: '-out=tfplan'
            workingDirectory: '$(terraform_templates_dir)'
            environmentServiceNameAzureRM: 'Visual Studio Enterprise – MPN(07209e8b-f025-434a-98ee-5e5430ed50b1)'

  - stage: deploy (manual approval)
    jobs:
    - job: terraform_apply
      steps:
        # - task: TerraformInstaller@0
        #   displayName: install terraform
        #   inputs:
        #     terraformVersion: 'latest'
        - task: TerraformTaskV2@2
          inputs:
            provider: 'azurerm'
            command: 'init'
            workingDirectory: $(terraform_templates_dir)
            backendServiceArm: 'Visual Studio Enterprise – MPN(07209e8b-f025-434a-98ee-5e5430ed50b1)'
            backendAzureRmResourceGroupName: 'RG-common-base'
            backendAzureRmStorageAccountName: 'tfcmmgtstatestore'
            backendAzureRmContainerName: 'tfstatecontainer'
            backendAzureRmKey: 'backendsetup.terraform.tfstate'
    #- job: planning
    #  steps:
        - task: TerraformTaskV2@2
          inputs:
            provider: 'azurerm'
            command: 'plan'
            commandOptions: '-out=tfplan'
            workingDirectory: '$(terraform_templates_dir)'
            environmentServiceNameAzureRM: 'Visual Studio Enterprise – MPN(07209e8b-f025-434a-98ee-5e5430ed50b1)'
        
        - task: ManualValidation@0
          # timeoutInMinutes: 1440 # task times out in 1 day
          timeoutInMinutes: 10 # task times out in 10 minutes
          inputs:
            notifyUsers: |
              dheep@net-research.com.au
            instructions: 'Please validate the auzre build configuration and resume'
            onTimeout: 'resume'

        - task: TerraformTaskV2@2
          inputs:
            provider: 'azurerm'
            command: 'apply'
            commandOptions: '-auto-approve'
            workingDirectory: '$(terraform_templates_dir)'
            environmentServiceNameAzureRM: 'Visual Studio Enterprise – MPN(07209e8b-f025-434a-98ee-5e5430ed50b1)'
